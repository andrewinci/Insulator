name: Release

on:
  push:
    tags:
      - '*.*.*'

jobs:

  package-app:
    runs-on: ${{ matrix.os.name }}
    strategy:
      matrix:
        os:
        - name: macos-latest
          artifact: insulator-mac
          path: Insulator*.dmg
        - name: ubuntu-latest
          artifact: insulator-debian
          path: insulator*.deb
        - name: windows-latest
          artifact: insulator-win
          path: Insulator*.exe
    steps:
    - uses: actions/checkout@v2
    - name: Setup Java JDK
      uses: actions/setup-java@v1.4.3
      with:
        java-version: 14
        java-package: jdk
    - name: Cache
      uses: actions/cache@v2
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
        restore-keys: ${{ runner.os }}-gradle-
    - uses: olegtarasov/get-tag@v2
      id: tagName
    - name: Gradle package
      run: "./gradlew packageApp"
      env:
        RELEASE_VERSION: ${{ steps.tagName.outputs.tag }}
    - uses: actions/upload-artifact@v2
      with:
        name: ${{ matrix.os.artifact }}
        path: "./app/${{ matrix.os.path }}"
        if-no-files-found: error

  create-release:
    runs-on: ubuntu-latest
    needs: package-app
    outputs:
      release-url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Create release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: true
          prerelease: true

  upload-artifacts:
    runs-on: ubuntu-latest
    needs: create-release
    strategy:
      matrix:
        artifact:
          - name: insulator-mac
            path: Insulator-*.dmg
          - name: insulator-win
            path: Insulator-*.exe
          - name: insulator-debian
            path: insulator*.deb
    steps:
      - name: Download asset from previous jobs
        uses: actions/download-artifact@v2
        with:
          name: ${{ matrix.artifact.name }}
      - name: Zip artifact
        run: |
          zip --junk-paths ${{ matrix.artifact.name }} ${{ matrix.artifact.path }}
      - name: Upload ${{ matrix.artifact.name }} asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.release-url }}
          asset_path: ./${{ matrix.artifact.name }}.zip
          asset_name: ${{ matrix.artifact.name }}.zip
          asset_content_type: application/zip
